#!/usr/bin/env python3

import requests
import os
import json

def post_sample(file_name, API_KEY):

    base_dir = "/media/cape/Malware/Nico/Dataset_Resized_Malicious_Binaries/wastedlocker"
    
    samples = os.listdir(base_dir)

    for sample in samples:
        SAMPLE = os.path.join(base_dir, sample)

        if get_file_size_mb(SAMPLE) < 32:
            url = "https://www.virustotal.com/api/v3/files"

            files = { "file": (SAMPLE, open(SAMPLE, "rb"), "application/x-ms-dos-executable") }

            headers = {
                "accept": "application/json",
                "x-apikey": API_KEY
            }

            response = requests.post(url, files=files, headers=headers)

            print("Upload done.")

        else:
            url = get_large_url(API_KEY)
            files = { "file": (SAMPLE, open(SAMPLE, "rb"), "application/x-ms-dos-executable") }

            headers = {
                "accept": "application/json",
                "x-apikey": API_KEY
            }

            response = requests.post(url, files=files, headers=headers)

            print("Upload done.")

# Returns a custom URL since some executables are larger than 32 Mb
def get_large_url(API_KEY):

    url = "https://www.virustotal.com/api/v3/files/upload_url"

    headers = {
        "accept": "application/json",
        "x-apikey": API_KEY
    }

    response = requests.get(url, headers=headers)

    return json.loads(response.text)['data']

# Returns the size of the file in megabytes.
def get_file_size_mb(file_path):

    file_size_bytes = os.path.getsize(file_path)

    file_size_mb = file_size_bytes / (1024 * 1024)

    return file_size_mb


post_sample("a", "PUT_HERE_THE_API_KEY")