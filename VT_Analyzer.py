#!/usr/bin/env python3

import requests

# Performs the upload of .exe examples
def post_sample(API_KEY, SAMPLE):

    if get_file_size_mb(SAMPLE) < 32:
        url = "https://www.virustotal.com/api/v3/files"
        files = { "file": (SAMPLE, open(SAMPLE, "rb"), "application/x-ms-dos-executable") }
    
        headers = {
            "accept": "application/json",
            "x-apikey": API_KEY
        }

        response = requests.post(url, headers=headers, files=files)

        return json.loads(response.text)['data']['links']['self']

    else:
        url = get_large_url(API_KEY)
        files = { "file": (SAMPLE, open(SAMPLE, "rb"), "application/x-ms-dos-executable") }
    
        headers = {
            "accept": "application/json",
            "x-apikey": API_KEY
        }

        response = requests.post(url, headers=headers, files=files)

        return json.loads(response.text)['data']['links']['self']

import json

# Returns a custom URL since some executables are larger than 32 Mb
def get_large_url(API_KEY):

    url = "https://www.virustotal.com/api/v3/files/upload_url"

    headers = {
        "accept": "application/json",
        "x-apikey": API_KEY
    }

    response = requests.get(url, headers=headers)

    return json.loads(response.text)['data']


import os

# Returns the size of the file in megabytes.
def get_file_size_mb(file_path):

    file_size_bytes = os.path.getsize(file_path)

    file_size_mb = file_size_bytes / (1024 * 1024)

    return file_size_mb

import sys 
import time

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python VT_Analyzer.py <API_KEY>")
        sys.exit(1)
    
    folder_path = '/media/cape/NewSamples/Thesis/Safe_'
    counter = 0
    links = []

    samples = os.listdir(folder_path)
    for sample in samples:
        try:
            SAMPLE = os.path.join(folder_path, sample)
            if counter % 4 == 0 and counter != 0:
                print("Waiting 1:05 minutes...")
                time.sleep(60+5)
    
            counter += 1
            links.append(post_sample(sys.argv[1], SAMPLE))

        except Exception as ex:
            print(SAMPLE, ex)
            continue

    with open('/home/cape/Desktop/Thesis/Links.txt', 'w') as file:
        for string in links:
            file.write(f"{string}\n")
    
    
    